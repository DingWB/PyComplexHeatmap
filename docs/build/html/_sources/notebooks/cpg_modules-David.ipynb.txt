{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "b8ded0e6-40d6-40cc-acf4-be968a89722a",
   "metadata": {},
   "source": [
    "# Plot correlation matrix for CpG modules using DotClustermap"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "31c96e25-b4a4-4824-82f4-c4cde1df25f9",
   "metadata": {},
   "source": [
    "## Processing the data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "id": "c8d5a344-f420-4937-9d8f-df045f87db99",
   "metadata": {},
   "outputs": [],
   "source": [
    "import os,sys\n",
    "%matplotlib inline\n",
    "import matplotlib.pylab as plt\n",
    "sys.path.append(os.path.expanduser(\"~/Projects/Github/PyComplexHeatmap/\"))\n",
    "from PyComplexHeatmap import *\n",
    "from matplotlib.colors import LinearSegmentedColormap\n",
    "\n",
    "df_corr = pd.read_csv(\"../data/kycg_modles_correlations.csv\",sep='\\t',index_col=0)\n",
    "df_ann = pd.read_csv(\"../data/kycg_modles_annotations.csv\",sep='\\t')\n",
    "df_ann.set_index('CpG',inplace=True)\n",
    "df_ann.Module=df_ann.Module.astype(str)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "id": "2be99556-d286-4a56-9286-be9043bdc547",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>cg04735237</th>\n",
       "      <th>cg00643814</th>\n",
       "      <th>cg24865495</th>\n",
       "      <th>cg25376651</th>\n",
       "      <th>cg27485084</th>\n",
       "      <th>cg12609052</th>\n",
       "      <th>cg07354679</th>\n",
       "      <th>cg02592525</th>\n",
       "      <th>cg12747056</th>\n",
       "      <th>cg17718960</th>\n",
       "      <th>...</th>\n",
       "      <th>cg19987665</th>\n",
       "      <th>cg18406033</th>\n",
       "      <th>cg09678971</th>\n",
       "      <th>cg00461612</th>\n",
       "      <th>cg18689454</th>\n",
       "      <th>cg11923631</th>\n",
       "      <th>cg27251412</th>\n",
       "      <th>cg08089567</th>\n",
       "      <th>cg16717549</th>\n",
       "      <th>cg09510531</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>cg04735237</th>\n",
       "      <td>1.000000</td>\n",
       "      <td>0.559916</td>\n",
       "      <td>0.686845</td>\n",
       "      <td>0.561415</td>\n",
       "      <td>0.699960</td>\n",
       "      <td>0.711086</td>\n",
       "      <td>0.563690</td>\n",
       "      <td>0.527953</td>\n",
       "      <td>0.621757</td>\n",
       "      <td>0.623319</td>\n",
       "      <td>...</td>\n",
       "      <td>0.048462</td>\n",
       "      <td>0.103904</td>\n",
       "      <td>-0.002533</td>\n",
       "      <td>0.074093</td>\n",
       "      <td>-0.114526</td>\n",
       "      <td>-0.151763</td>\n",
       "      <td>-0.140823</td>\n",
       "      <td>-0.117356</td>\n",
       "      <td>-0.100510</td>\n",
       "      <td>-0.126291</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>cg00643814</th>\n",
       "      <td>0.559916</td>\n",
       "      <td>1.000000</td>\n",
       "      <td>0.538034</td>\n",
       "      <td>0.568960</td>\n",
       "      <td>0.687787</td>\n",
       "      <td>0.593650</td>\n",
       "      <td>0.676068</td>\n",
       "      <td>0.606604</td>\n",
       "      <td>0.589549</td>\n",
       "      <td>0.747987</td>\n",
       "      <td>...</td>\n",
       "      <td>-0.185989</td>\n",
       "      <td>-0.087952</td>\n",
       "      <td>-0.242909</td>\n",
       "      <td>-0.065101</td>\n",
       "      <td>-0.054958</td>\n",
       "      <td>-0.096098</td>\n",
       "      <td>-0.089246</td>\n",
       "      <td>-0.078234</td>\n",
       "      <td>-0.025965</td>\n",
       "      <td>-0.069120</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>cg24865495</th>\n",
       "      <td>0.686845</td>\n",
       "      <td>0.538034</td>\n",
       "      <td>1.000000</td>\n",
       "      <td>0.614696</td>\n",
       "      <td>0.646452</td>\n",
       "      <td>0.786480</td>\n",
       "      <td>0.602911</td>\n",
       "      <td>0.519926</td>\n",
       "      <td>0.642344</td>\n",
       "      <td>0.642081</td>\n",
       "      <td>...</td>\n",
       "      <td>0.022499</td>\n",
       "      <td>0.108524</td>\n",
       "      <td>-0.015151</td>\n",
       "      <td>0.028957</td>\n",
       "      <td>-0.274560</td>\n",
       "      <td>-0.302464</td>\n",
       "      <td>-0.284823</td>\n",
       "      <td>-0.265835</td>\n",
       "      <td>-0.262931</td>\n",
       "      <td>-0.268134</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>cg25376651</th>\n",
       "      <td>0.561415</td>\n",
       "      <td>0.568960</td>\n",
       "      <td>0.614696</td>\n",
       "      <td>1.000000</td>\n",
       "      <td>0.564983</td>\n",
       "      <td>0.727579</td>\n",
       "      <td>0.624186</td>\n",
       "      <td>0.416198</td>\n",
       "      <td>0.505130</td>\n",
       "      <td>0.596338</td>\n",
       "      <td>...</td>\n",
       "      <td>-0.030346</td>\n",
       "      <td>0.122412</td>\n",
       "      <td>-0.063630</td>\n",
       "      <td>-0.007048</td>\n",
       "      <td>-0.197339</td>\n",
       "      <td>-0.226034</td>\n",
       "      <td>-0.218230</td>\n",
       "      <td>-0.180297</td>\n",
       "      <td>-0.181867</td>\n",
       "      <td>-0.204431</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>cg27485084</th>\n",
       "      <td>0.699960</td>\n",
       "      <td>0.687787</td>\n",
       "      <td>0.646452</td>\n",
       "      <td>0.564983</td>\n",
       "      <td>1.000000</td>\n",
       "      <td>0.655515</td>\n",
       "      <td>0.599935</td>\n",
       "      <td>0.590981</td>\n",
       "      <td>0.627786</td>\n",
       "      <td>0.674095</td>\n",
       "      <td>...</td>\n",
       "      <td>-0.020895</td>\n",
       "      <td>0.058742</td>\n",
       "      <td>-0.078318</td>\n",
       "      <td>0.055019</td>\n",
       "      <td>-0.139691</td>\n",
       "      <td>-0.168351</td>\n",
       "      <td>-0.160081</td>\n",
       "      <td>-0.142216</td>\n",
       "      <td>-0.114554</td>\n",
       "      <td>-0.144024</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>5 rows × 512 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "            cg04735237  cg00643814  cg24865495  cg25376651  cg27485084  \\\n",
       "cg04735237  1.000000    0.559916    0.686845    0.561415    0.699960     \n",
       "cg00643814  0.559916    1.000000    0.538034    0.568960    0.687787     \n",
       "cg24865495  0.686845    0.538034    1.000000    0.614696    0.646452     \n",
       "cg25376651  0.561415    0.568960    0.614696    1.000000    0.564983     \n",
       "cg27485084  0.699960    0.687787    0.646452    0.564983    1.000000     \n",
       "\n",
       "            cg12609052  cg07354679  cg02592525  cg12747056  cg17718960  ...  \\\n",
       "cg04735237  0.711086    0.563690    0.527953    0.621757    0.623319    ...   \n",
       "cg00643814  0.593650    0.676068    0.606604    0.589549    0.747987    ...   \n",
       "cg24865495  0.786480    0.602911    0.519926    0.642344    0.642081    ...   \n",
       "cg25376651  0.727579    0.624186    0.416198    0.505130    0.596338    ...   \n",
       "cg27485084  0.655515    0.599935    0.590981    0.627786    0.674095    ...   \n",
       "\n",
       "            cg19987665  cg18406033  cg09678971  cg00461612  cg18689454  \\\n",
       "cg04735237  0.048462    0.103904   -0.002533    0.074093   -0.114526     \n",
       "cg00643814 -0.185989   -0.087952   -0.242909   -0.065101   -0.054958     \n",
       "cg24865495  0.022499    0.108524   -0.015151    0.028957   -0.274560     \n",
       "cg25376651 -0.030346    0.122412   -0.063630   -0.007048   -0.197339     \n",
       "cg27485084 -0.020895    0.058742   -0.078318    0.055019   -0.139691     \n",
       "\n",
       "            cg11923631  cg27251412  cg08089567  cg16717549  cg09510531  \n",
       "cg04735237 -0.151763   -0.140823   -0.117356   -0.100510   -0.126291    \n",
       "cg00643814 -0.096098   -0.089246   -0.078234   -0.025965   -0.069120    \n",
       "cg24865495 -0.302464   -0.284823   -0.265835   -0.262931   -0.268134    \n",
       "cg25376651 -0.226034   -0.218230   -0.180297   -0.181867   -0.204431    \n",
       "cg27485084 -0.168351   -0.160081   -0.142216   -0.114554   -0.144024    \n",
       "\n",
       "[5 rows x 512 columns]"
      ]
     },
     "execution_count": 27,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_corr.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "id": "5fcaf02d-43c4-4398-8705-dd376928158a",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Module</th>\n",
       "      <th>ChromHMM</th>\n",
       "      <th>ChromHMM_bioc</th>\n",
       "      <th>HM</th>\n",
       "      <th>TFBS</th>\n",
       "      <th>genes</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>CpG</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>cg04735237</th>\n",
       "      <td>1</td>\n",
       "      <td>TxWk</td>\n",
       "      <td>TxWk</td>\n",
       "      <td>H3K4me1;H3K79me2;H3K79me3</td>\n",
       "      <td>HDGF;RBFOX2;SREBF1</td>\n",
       "      <td>PQBP1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>cg00643814</th>\n",
       "      <td>1</td>\n",
       "      <td>Quies</td>\n",
       "      <td>Quies</td>\n",
       "      <td>H3F3A;H4K20me1</td>\n",
       "      <td>ASCL1;CASZ1;EBF1;FEZF1;FOXM1;HAND2;HDAC3;IRF2BP2;ISL1;MAFB;NEUROG2;NKX3-1;OSR2;PAX6;PAXIP1;PDX1;PHOX2B;PRDM4;PRDM6;RBBP4;SCRT1;SIX1;SMARCA2;SMC1A-B;SP140L;TSHZ1;WT1;ZBTB21;ZBTB44;ZBTB7B;ZBTB8A;ZNF10;ZNF189;ZNF2;ZNF213;ZNF335;ZNF35;ZNF366;ZNF528;ZNF561;ZNF580;ZNF629;ZNF843;ZXDB</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>cg24865495</th>\n",
       "      <td>1</td>\n",
       "      <td>Quies</td>\n",
       "      <td>Quies</td>\n",
       "      <td>NaN</td>\n",
       "      <td>CRX;DNMT3B;OTX2;RORB;ZMYND11;ZNF711</td>\n",
       "      <td>MACROD1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>cg25376651</th>\n",
       "      <td>1</td>\n",
       "      <td>Quies</td>\n",
       "      <td>Quies</td>\n",
       "      <td>H2BK20ac;H3K4me1</td>\n",
       "      <td>ATF2;BATF;ETV6;FOS;IKZF2;IRF4;JUNB;MAF;MAFG;MEF2B;NFATC3;NFE2L2;NR1H2;PPARG;RELB;SKIL;SMAD3-HIF1A;SMARCA5;SMARCD3;TBX21;TERF1;TRIM22;ZFP36</td>\n",
       "      <td>FRY</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>cg27485084</th>\n",
       "      <td>1</td>\n",
       "      <td>Quies</td>\n",
       "      <td>Quies</td>\n",
       "      <td>H3F3A;H3K23me2</td>\n",
       "      <td>PDX1</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "           Module ChromHMM ChromHMM_bioc                         HM  \\\n",
       "CpG                                                                   \n",
       "cg04735237  1      TxWk     TxWk          H3K4me1;H3K79me2;H3K79me3   \n",
       "cg00643814  1      Quies    Quies         H3F3A;H4K20me1              \n",
       "cg24865495  1      Quies    Quies         NaN                         \n",
       "cg25376651  1      Quies    Quies         H2BK20ac;H3K4me1            \n",
       "cg27485084  1      Quies    Quies         H3F3A;H3K23me2              \n",
       "\n",
       "                                                                                                                                                                                                                                                                                             TFBS  \\\n",
       "CpG                                                                                                                                                                                                                                                                                                 \n",
       "cg04735237  HDGF;RBFOX2;SREBF1                                                                                                                                                                                                                                                                      \n",
       "cg00643814  ASCL1;CASZ1;EBF1;FEZF1;FOXM1;HAND2;HDAC3;IRF2BP2;ISL1;MAFB;NEUROG2;NKX3-1;OSR2;PAX6;PAXIP1;PDX1;PHOX2B;PRDM4;PRDM6;RBBP4;SCRT1;SIX1;SMARCA2;SMC1A-B;SP140L;TSHZ1;WT1;ZBTB21;ZBTB44;ZBTB7B;ZBTB8A;ZNF10;ZNF189;ZNF2;ZNF213;ZNF335;ZNF35;ZNF366;ZNF528;ZNF561;ZNF580;ZNF629;ZNF843;ZXDB   \n",
       "cg24865495  CRX;DNMT3B;OTX2;RORB;ZMYND11;ZNF711                                                                                                                                                                                                                                                     \n",
       "cg25376651  ATF2;BATF;ETV6;FOS;IKZF2;IRF4;JUNB;MAF;MAFG;MEF2B;NFATC3;NFE2L2;NR1H2;PPARG;RELB;SKIL;SMAD3-HIF1A;SMARCA5;SMARCD3;TBX21;TERF1;TRIM22;ZFP36                                                                                                                                              \n",
       "cg27485084  PDX1                                                                                                                                                                                                                                                                                    \n",
       "\n",
       "              genes  \n",
       "CpG                  \n",
       "cg04735237  PQBP1    \n",
       "cg00643814  NaN      \n",
       "cg24865495  MACROD1  \n",
       "cg25376651  FRY      \n",
       "cg27485084  NaN      "
      ]
     },
     "execution_count": 28,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_ann.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 29,
   "id": "08f9deae-cd8c-48db-b7c4-056e5a7458e2",
   "metadata": {},
   "outputs": [],
   "source": [
    "beta = pd.read_csv(\"../data/kycg_modles_betas.csv\",sep='\\t')\n",
    "cpg_std = beta.std().to_dict()\n",
    "cpg_mean = beta.mean().to_dict()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 30,
   "id": "51489b55-5229-416f-8db1-e5b7829bd690",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>cg04735237</th>\n",
       "      <th>cg00643814</th>\n",
       "      <th>cg24865495</th>\n",
       "      <th>cg25376651</th>\n",
       "      <th>cg27485084</th>\n",
       "      <th>cg12609052</th>\n",
       "      <th>cg07354679</th>\n",
       "      <th>cg02592525</th>\n",
       "      <th>cg12747056</th>\n",
       "      <th>cg17718960</th>\n",
       "      <th>...</th>\n",
       "      <th>cg19987665</th>\n",
       "      <th>cg18406033</th>\n",
       "      <th>cg09678971</th>\n",
       "      <th>cg00461612</th>\n",
       "      <th>cg18689454</th>\n",
       "      <th>cg11923631</th>\n",
       "      <th>cg27251412</th>\n",
       "      <th>cg08089567</th>\n",
       "      <th>cg16717549</th>\n",
       "      <th>cg09510531</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>GSM2404117</th>\n",
       "      <td>0.900481</td>\n",
       "      <td>0.603055</td>\n",
       "      <td>0.964585</td>\n",
       "      <td>0.964384</td>\n",
       "      <td>0.954552</td>\n",
       "      <td>0.944536</td>\n",
       "      <td>0.968595</td>\n",
       "      <td>0.978733</td>\n",
       "      <td>0.968699</td>\n",
       "      <td>0.968735</td>\n",
       "      <td>...</td>\n",
       "      <td>0.758728</td>\n",
       "      <td>0.383938</td>\n",
       "      <td>0.475512</td>\n",
       "      <td>0.933101</td>\n",
       "      <td>0.050961</td>\n",
       "      <td>0.020880</td>\n",
       "      <td>0.074912</td>\n",
       "      <td>0.257853</td>\n",
       "      <td>0.082847</td>\n",
       "      <td>0.119769</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>GSM2404212</th>\n",
       "      <td>0.947537</td>\n",
       "      <td>0.913293</td>\n",
       "      <td>0.980726</td>\n",
       "      <td>0.922994</td>\n",
       "      <td>0.922136</td>\n",
       "      <td>0.950296</td>\n",
       "      <td>0.767177</td>\n",
       "      <td>0.968805</td>\n",
       "      <td>0.968858</td>\n",
       "      <td>0.924925</td>\n",
       "      <td>...</td>\n",
       "      <td>0.158342</td>\n",
       "      <td>0.794200</td>\n",
       "      <td>0.402526</td>\n",
       "      <td>0.314821</td>\n",
       "      <td>0.150204</td>\n",
       "      <td>0.133016</td>\n",
       "      <td>0.168452</td>\n",
       "      <td>0.407139</td>\n",
       "      <td>0.199282</td>\n",
       "      <td>0.205946</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>GSM2404219</th>\n",
       "      <td>0.921301</td>\n",
       "      <td>0.943013</td>\n",
       "      <td>0.932705</td>\n",
       "      <td>0.902705</td>\n",
       "      <td>0.839878</td>\n",
       "      <td>0.905491</td>\n",
       "      <td>0.962050</td>\n",
       "      <td>0.966595</td>\n",
       "      <td>0.942915</td>\n",
       "      <td>0.927500</td>\n",
       "      <td>...</td>\n",
       "      <td>0.254501</td>\n",
       "      <td>0.438526</td>\n",
       "      <td>0.284634</td>\n",
       "      <td>0.701462</td>\n",
       "      <td>0.286889</td>\n",
       "      <td>0.227331</td>\n",
       "      <td>0.226151</td>\n",
       "      <td>0.395520</td>\n",
       "      <td>0.360743</td>\n",
       "      <td>0.279637</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>GSM2404221</th>\n",
       "      <td>0.910841</td>\n",
       "      <td>0.951249</td>\n",
       "      <td>0.966403</td>\n",
       "      <td>0.904002</td>\n",
       "      <td>0.904658</td>\n",
       "      <td>0.902807</td>\n",
       "      <td>0.903534</td>\n",
       "      <td>0.906914</td>\n",
       "      <td>0.945465</td>\n",
       "      <td>0.939869</td>\n",
       "      <td>...</td>\n",
       "      <td>0.273613</td>\n",
       "      <td>0.352813</td>\n",
       "      <td>0.258552</td>\n",
       "      <td>0.304284</td>\n",
       "      <td>0.678915</td>\n",
       "      <td>0.596207</td>\n",
       "      <td>0.547552</td>\n",
       "      <td>0.494456</td>\n",
       "      <td>0.681013</td>\n",
       "      <td>0.566912</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>GSM2404222</th>\n",
       "      <td>0.876562</td>\n",
       "      <td>0.854672</td>\n",
       "      <td>0.941902</td>\n",
       "      <td>0.891581</td>\n",
       "      <td>0.713530</td>\n",
       "      <td>0.847356</td>\n",
       "      <td>0.851141</td>\n",
       "      <td>0.803102</td>\n",
       "      <td>0.933793</td>\n",
       "      <td>0.907985</td>\n",
       "      <td>...</td>\n",
       "      <td>0.288605</td>\n",
       "      <td>0.504090</td>\n",
       "      <td>0.269190</td>\n",
       "      <td>0.464615</td>\n",
       "      <td>0.418153</td>\n",
       "      <td>0.312901</td>\n",
       "      <td>0.357180</td>\n",
       "      <td>0.357346</td>\n",
       "      <td>0.461659</td>\n",
       "      <td>0.396292</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>5 rows × 512 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "            cg04735237  cg00643814  cg24865495  cg25376651  cg27485084  \\\n",
       "GSM2404117  0.900481    0.603055    0.964585    0.964384    0.954552     \n",
       "GSM2404212  0.947537    0.913293    0.980726    0.922994    0.922136     \n",
       "GSM2404219  0.921301    0.943013    0.932705    0.902705    0.839878     \n",
       "GSM2404221  0.910841    0.951249    0.966403    0.904002    0.904658     \n",
       "GSM2404222  0.876562    0.854672    0.941902    0.891581    0.713530     \n",
       "\n",
       "            cg12609052  cg07354679  cg02592525  cg12747056  cg17718960  ...  \\\n",
       "GSM2404117  0.944536    0.968595    0.978733    0.968699    0.968735    ...   \n",
       "GSM2404212  0.950296    0.767177    0.968805    0.968858    0.924925    ...   \n",
       "GSM2404219  0.905491    0.962050    0.966595    0.942915    0.927500    ...   \n",
       "GSM2404221  0.902807    0.903534    0.906914    0.945465    0.939869    ...   \n",
       "GSM2404222  0.847356    0.851141    0.803102    0.933793    0.907985    ...   \n",
       "\n",
       "            cg19987665  cg18406033  cg09678971  cg00461612  cg18689454  \\\n",
       "GSM2404117  0.758728    0.383938    0.475512    0.933101    0.050961     \n",
       "GSM2404212  0.158342    0.794200    0.402526    0.314821    0.150204     \n",
       "GSM2404219  0.254501    0.438526    0.284634    0.701462    0.286889     \n",
       "GSM2404221  0.273613    0.352813    0.258552    0.304284    0.678915     \n",
       "GSM2404222  0.288605    0.504090    0.269190    0.464615    0.418153     \n",
       "\n",
       "            cg11923631  cg27251412  cg08089567  cg16717549  cg09510531  \n",
       "GSM2404117  0.020880    0.074912    0.257853    0.082847    0.119769    \n",
       "GSM2404212  0.133016    0.168452    0.407139    0.199282    0.205946    \n",
       "GSM2404219  0.227331    0.226151    0.395520    0.360743    0.279637    \n",
       "GSM2404221  0.596207    0.547552    0.494456    0.681013    0.566912    \n",
       "GSM2404222  0.312901    0.357180    0.357346    0.461659    0.396292    \n",
       "\n",
       "[5 rows x 512 columns]"
      ]
     },
     "execution_count": 30,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "beta.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 31,
   "id": "669456d3-382a-4b66-a501-08ff021927da",
   "metadata": {},
   "outputs": [],
   "source": [
    "# df_ann=df_ann.loc[df_ann.Module.isin(['4','1','3','9','2','39'])]\n",
    "df_ann['Mean']=df_ann.index.to_series().map(cpg_mean)\n",
    "df_ann['Std']=df_ann.index.to_series().map(cpg_std)\n",
    "keep_cpgs=df_ann.index.tolist()\n",
    "df_corr=df_corr.loc[keep_cpgs,keep_cpgs]\n",
    "data=df_corr.stack().reset_index()\n",
    "data.columns=['X','Y','Correlation']\n",
    "data['Module']=data.X.map(df_ann.Module.to_dict())\n",
    "data['ChromHMM']=data.X.map(df_ann.ChromHMM.to_dict())\n",
    "keep_hm=['H3K4me1','H3K4me3','H3K27me1','H3K27me3B']\n",
    "for hm in keep_hm:\n",
    "    df_ann[hm]=df_ann.HM.fillna('').apply(lambda x:1 if hm in x.split(';') else 0)\n",
    "    data[hm]=data.X.map(df_ann[hm].to_dict())"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 32,
   "id": "c39de42c-ed05-4a07-96ce-b9c04a8421de",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "(512, 12)\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Module</th>\n",
       "      <th>ChromHMM</th>\n",
       "      <th>ChromHMM_bioc</th>\n",
       "      <th>HM</th>\n",
       "      <th>TFBS</th>\n",
       "      <th>genes</th>\n",
       "      <th>Mean</th>\n",
       "      <th>Std</th>\n",
       "      <th>H3K4me1</th>\n",
       "      <th>H3K4me3</th>\n",
       "      <th>H3K27me1</th>\n",
       "      <th>H3K27me3B</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>CpG</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>cg04735237</th>\n",
       "      <td>1</td>\n",
       "      <td>TxWk</td>\n",
       "      <td>TxWk</td>\n",
       "      <td>H3K4me1;H3K79me2;H3K79me3</td>\n",
       "      <td>HDGF;RBFOX2;SREBF1</td>\n",
       "      <td>PQBP1</td>\n",
       "      <td>0.768918</td>\n",
       "      <td>0.245870</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>cg00643814</th>\n",
       "      <td>1</td>\n",
       "      <td>Quies</td>\n",
       "      <td>Quies</td>\n",
       "      <td>H3F3A;H4K20me1</td>\n",
       "      <td>ASCL1;CASZ1;EBF1;FEZF1;FOXM1;HAND2;HDAC3;IRF2BP2;ISL1;MAFB;NEUROG2;NKX3-1;OSR2;PAX6;PAXIP1;PDX1;PHOX2B;PRDM4;PRDM6;RBBP4;SCRT1;SIX1;SMARCA2;SMC1A-B;SP140L;TSHZ1;WT1;ZBTB21;ZBTB44;ZBTB7B;ZBTB8A;ZNF10;ZNF189;ZNF2;ZNF213;ZNF335;ZNF35;ZNF366;ZNF528;ZNF561;ZNF580;ZNF629;ZNF843;ZXDB</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.635635</td>\n",
       "      <td>0.319166</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>cg24865495</th>\n",
       "      <td>1</td>\n",
       "      <td>Quies</td>\n",
       "      <td>Quies</td>\n",
       "      <td>NaN</td>\n",
       "      <td>CRX;DNMT3B;OTX2;RORB;ZMYND11;ZNF711</td>\n",
       "      <td>MACROD1</td>\n",
       "      <td>0.835897</td>\n",
       "      <td>0.270459</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>cg25376651</th>\n",
       "      <td>1</td>\n",
       "      <td>Quies</td>\n",
       "      <td>Quies</td>\n",
       "      <td>H2BK20ac;H3K4me1</td>\n",
       "      <td>ATF2;BATF;ETV6;FOS;IKZF2;IRF4;JUNB;MAF;MAFG;MEF2B;NFATC3;NFE2L2;NR1H2;PPARG;RELB;SKIL;SMAD3-HIF1A;SMARCA5;SMARCD3;TBX21;TERF1;TRIM22;ZFP36</td>\n",
       "      <td>FRY</td>\n",
       "      <td>0.618949</td>\n",
       "      <td>0.276320</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>cg27485084</th>\n",
       "      <td>1</td>\n",
       "      <td>Quies</td>\n",
       "      <td>Quies</td>\n",
       "      <td>H3F3A;H3K23me2</td>\n",
       "      <td>PDX1</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.700196</td>\n",
       "      <td>0.276748</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "           Module ChromHMM ChromHMM_bioc                         HM  \\\n",
       "CpG                                                                   \n",
       "cg04735237  1      TxWk     TxWk          H3K4me1;H3K79me2;H3K79me3   \n",
       "cg00643814  1      Quies    Quies         H3F3A;H4K20me1              \n",
       "cg24865495  1      Quies    Quies         NaN                         \n",
       "cg25376651  1      Quies    Quies         H2BK20ac;H3K4me1            \n",
       "cg27485084  1      Quies    Quies         H3F3A;H3K23me2              \n",
       "\n",
       "                                                                                                                                                                                                                                                                                             TFBS  \\\n",
       "CpG                                                                                                                                                                                                                                                                                                 \n",
       "cg04735237  HDGF;RBFOX2;SREBF1                                                                                                                                                                                                                                                                      \n",
       "cg00643814  ASCL1;CASZ1;EBF1;FEZF1;FOXM1;HAND2;HDAC3;IRF2BP2;ISL1;MAFB;NEUROG2;NKX3-1;OSR2;PAX6;PAXIP1;PDX1;PHOX2B;PRDM4;PRDM6;RBBP4;SCRT1;SIX1;SMARCA2;SMC1A-B;SP140L;TSHZ1;WT1;ZBTB21;ZBTB44;ZBTB7B;ZBTB8A;ZNF10;ZNF189;ZNF2;ZNF213;ZNF335;ZNF35;ZNF366;ZNF528;ZNF561;ZNF580;ZNF629;ZNF843;ZXDB   \n",
       "cg24865495  CRX;DNMT3B;OTX2;RORB;ZMYND11;ZNF711                                                                                                                                                                                                                                                     \n",
       "cg25376651  ATF2;BATF;ETV6;FOS;IKZF2;IRF4;JUNB;MAF;MAFG;MEF2B;NFATC3;NFE2L2;NR1H2;PPARG;RELB;SKIL;SMAD3-HIF1A;SMARCA5;SMARCD3;TBX21;TERF1;TRIM22;ZFP36                                                                                                                                              \n",
       "cg27485084  PDX1                                                                                                                                                                                                                                                                                    \n",
       "\n",
       "              genes      Mean       Std  H3K4me1  H3K4me3  H3K27me1  H3K27me3B  \n",
       "CpG                                                                             \n",
       "cg04735237  PQBP1    0.768918  0.245870  1        0        0         0          \n",
       "cg00643814  NaN      0.635635  0.319166  0        0        0         0          \n",
       "cg24865495  MACROD1  0.835897  0.270459  0        0        0         0          \n",
       "cg25376651  FRY      0.618949  0.276320  1        0        0         0          \n",
       "cg27485084  NaN      0.700196  0.276748  0        0        0         0          "
      ]
     },
     "execution_count": 32,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "print(df_ann.shape)\n",
    "df_ann.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 33,
   "id": "23622cca-5d32-4e2e-b489-cbd2dc996c10",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "(262144, 9)\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>X</th>\n",
       "      <th>Y</th>\n",
       "      <th>Correlation</th>\n",
       "      <th>Module</th>\n",
       "      <th>ChromHMM</th>\n",
       "      <th>H3K4me1</th>\n",
       "      <th>H3K4me3</th>\n",
       "      <th>H3K27me1</th>\n",
       "      <th>H3K27me3B</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>cg04735237</td>\n",
       "      <td>cg04735237</td>\n",
       "      <td>1.000000</td>\n",
       "      <td>1</td>\n",
       "      <td>TxWk</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>cg04735237</td>\n",
       "      <td>cg00643814</td>\n",
       "      <td>0.559916</td>\n",
       "      <td>1</td>\n",
       "      <td>TxWk</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>cg04735237</td>\n",
       "      <td>cg24865495</td>\n",
       "      <td>0.686845</td>\n",
       "      <td>1</td>\n",
       "      <td>TxWk</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>cg04735237</td>\n",
       "      <td>cg25376651</td>\n",
       "      <td>0.561415</td>\n",
       "      <td>1</td>\n",
       "      <td>TxWk</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>cg04735237</td>\n",
       "      <td>cg27485084</td>\n",
       "      <td>0.699960</td>\n",
       "      <td>1</td>\n",
       "      <td>TxWk</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "            X           Y  Correlation Module ChromHMM  H3K4me1  H3K4me3  \\\n",
       "0  cg04735237  cg04735237  1.000000     1      TxWk     1        0         \n",
       "1  cg04735237  cg00643814  0.559916     1      TxWk     1        0         \n",
       "2  cg04735237  cg24865495  0.686845     1      TxWk     1        0         \n",
       "3  cg04735237  cg25376651  0.561415     1      TxWk     1        0         \n",
       "4  cg04735237  cg27485084  0.699960     1      TxWk     1        0         \n",
       "\n",
       "   H3K27me1  H3K27me3B  \n",
       "0  0         0          \n",
       "1  0         0          \n",
       "2  0         0          \n",
       "3  0         0          \n",
       "4  0         0          "
      ]
     },
     "execution_count": 33,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "print(data.shape)\n",
    "data.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "534c111e-ed23-4d3a-97b3-276e9ac77f0e",
   "metadata": {},
   "source": [
    "## Plotting the Dot clustermap"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0a3af02e-c783-4a93-915c-4c35b6d3ec0c",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Starting plotting..\n",
      "Starting calculating row orders..\n",
      "Reordering rows..\n",
      "Starting calculating col orders..\n",
      "Reordering cols..\n",
      "Plotting matrix..\n"
     ]
    }
   ],
   "source": [
    "row_ha = HeatmapAnnotation(Module=anno_simple(df_ann.Module,cmap='Dark2',legend=False,height=5,\n",
    "                                              add_text=True,text_kws={'color':'black','fontsize':12}),\n",
    "                           axis=0,verbose=0,label_kws={'visible':False})\n",
    "\n",
    "all_cmaps=matplotlib.pyplot.colormaps()\n",
    "if 'binarize' not in all_cmaps:\n",
    "    c = LinearSegmentedColormap.from_list('binarize', [(0, 'lightgray'), (1, 'black')])\n",
    "    plt.register_cmap(cmap=c)\n",
    "\n",
    "col_ha = HeatmapAnnotation(#label=anno_label(df_col.ColGroup, merge=True,rotation=45),\n",
    "                           Module=anno_simple(df_ann.Module,cmap='Dark2',legend=False,height=5,\n",
    "                                              add_text=True,text_kws={'color':'black','fontsize':12}),\n",
    "                           ChromHMM=anno_simple(df_ann.ChromHMM,cmap='tab20'),\n",
    "                           Std=anno_barplot(df_ann.Std,cmap='jet'),\n",
    "                           Mean=anno_barplot(df_ann.Mean,cmap='jet'),\n",
    "                           # H3K4me1=anno_simple(df_ann.H3K4me1,cmap='binarize',legend=False),\n",
    "                           # H3K4me3=anno_simple(df_ann.H3K4me3,cmap='binarize',legend=False),\n",
    "                           # H3K27me1=anno_simple(df_ann.H3K27me1,cmap='binarize',legend=False),\n",
    "                           # H3K27me3B=anno_simple(df_ann.H3K27me3B,cmap='binarize',legend=False),\n",
    "                           verbose=0,label_side='right',\n",
    "                           label_kws={'horizontalalignment':'left'})\n",
    "\n",
    "plt.figure(figsize=(12, 12))\n",
    "cm = DotClustermapPlotter(data=data, x='X',y='Y',value='Correlation',c='Correlation',s='Correlation',\n",
    "                          hue='Module', cmap='jet',#cmap={'High':'Reds','Middle':'Purples','Low':'Greens'},\n",
    "                          #colors={'High':'red','Middle':'purple','Low':'green'},\n",
    "                          #marker={'4':'P','1':'*','3':'D'},\n",
    "                          top_annotation=col_ha,right_annotation=row_ha,\n",
    "                          col_split=df_ann.Module,row_split=df_ann.Module, col_split_gap=0,row_split_gap=0,\n",
    "                          row_dendrogram=True,legend_anchor=\"ax_heatmap\",legend_hpad=7,legend_vpad=5,\n",
    "                          tree_kws={'row_cmap':'Dark2'},legend_gap=7,alpha=2,rasterized=True)\n",
    "plt.savefig(\"dotClustermap3.pdf\", bbox_inches='tight')\n",
    "plt.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3739da9a-d22a-42d0-9265-ebf18ddf663c",
   "metadata": {},
   "outputs": [],
   "source": [
    "print(data.X.nunique())"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.12"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
